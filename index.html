<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PokéPark KANTO Pins 漲跌幅追蹤（Mercari）</title>
  <style>
    :root{--bg:#0b0d12;--card:#121624;--muted:#8b94aa;--text:#e9ecf5;--line:#232a3d;--chip:#1b2235;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:linear-gradient(180deg,#0b0d12,#0b0d12 40%,#0e1220);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.6}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select,button{
      background:var(--card);border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none
    }
    button{cursor:pointer}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:7px 10px;border-radius:999px;font-size:12px}
    .chip strong{color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:760px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:repeat(1,minmax(0,1fr))}}
    .card{background:linear-gradient(180deg,#121624,#0f1320);border:1px solid var(--line);border-radius:16px;padding:12px;position:relative}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-end}
    .num{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}
    .name{font-size:14px;font-weight:750}
    .k{color:var(--muted);font-size:12px;margin-top:10px}
    .v{font-size:14px;margin-top:6px}
    .delta{font-variant-numeric:tabular-nums;font-size:13px}
    .delta.up{color:#7CFFB2}
    .delta.down{color:#FF7C7C}
    .delta.flat{color:#C7D2FE}
    .links{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    a.pill{display:inline-flex;gap:8px;align-items:center;text-decoration:none;background:#1c2743;border:1px solid #2a3960;color:#cfe0ff;padding:6px 8px;border-radius:999px;font-size:12px}
    .chartWrap{margin-top:10px;background:#0b0d12;border:1px solid var(--line);border-radius:12px;padding:10px}
    canvas{width:100%;height:220px}
    .footer{margin-top:16px;color:var(--muted);font-size:12px;line-height:1.6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .badge{position:absolute;top:10px;right:10px;background:#1b2235;border:1px solid #2a3960;color:#cfe0ff;border-radius:999px;padding:6px 10px;font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PokéPark KANTO Pins 漲跌幅追蹤（Mercari）</h1>
        <div class="sub">
          只用日文關鍵字：<span class="mono">ポケパークカントー ピンバッジ</span><br/>
          同時抓：已售出（sold_out）+ 交易中（on_sale）。匹配條件：標題只要含寶可夢名稱（No. 有就更準）。
        </div>
        <div class="chips" id="stats"></div>
      </div>

      <div class="bar">
        <select id="statusFilter">
          <option value="all">狀態：全部</option>
          <option value="sold_out">狀態：已售出</option>
          <option value="on_sale">狀態：交易中</option>
        </select>
        <select id="sort">
          <option value="delta_sold">排序：漲跌幅（已售出）</option>
          <option value="latest_sold">排序：最新成交（已售出）</option>
          <option value="latest_on">排序：最新價格（交易中）</option>
          <option value="count">排序：資料筆數</option>
          <option value="id">排序：編號</option>
        </select>
        <input id="q" placeholder="搜尋：編號/名稱（例 150 或 ミュウ）" />
        <button id="btnReload">重新載入資料</button>
      </div>
    </header>

    <main class="grid" id="grid"></main>

    <div class="footer">
      資料來源：Mercari 公開頁（以 Playwright 低頻率擷取）。若 Mercari 改版，請看 <span class="mono">data/sold.json</span> 內的 debug 統計與 debug HTML。
    </div>
  </div>

<script>
  const ZH = ["",
    "妙蛙種子","妙蛙草","妙蛙花","小火龍","火恐龍","噴火龍","傑尼龜","卡咪龜","水箭龜",
    "綠毛蟲","鐵甲蛹","巴大蝶","獨角蟲","鐵殼蛹","大針蜂","波波","比比鳥","大比鳥",
    "小拉達","拉達","烈雀","大嘴雀","阿柏蛇","阿柏怪","皮卡丘","雷丘","穿山鼠","穿山王",
    "尼多蘭","尼多娜","尼多后","尼多朗","尼多力諾","尼多王","皮皮","皮可西","六尾","九尾",
    "胖丁","胖可丁","超音蝠","大嘴蝠","走路草","臭臭花","霸王花","派拉斯","派拉斯特","毛球",
    "摩魯蛾","地鼠","三地鼠","喵喵","貓老大","可達鴨","哥達鴨","猴怪","火爆猴","卡蒂狗",
    "風速狗","蚊香蝌蚪","蚊香君","蚊香泳士","凱西","勇基拉","胡地","腕力","豪力","怪力",
    "喇叭芽","口呆花","大食花","瑪瑙水母","毒刺水母","小拳石","隆隆石","隆隆岩","小火馬","烈焰馬",
    "呆呆獸","呆殼獸","小磁怪","三合一磁怪","大蔥鴨","嘟嘟","嘟嘟利","小海獅","白海獅","臭泥",
    "臭臭泥","大舌貝","刺甲貝","鬼斯","鬼斯通","耿鬼","大岩蛇","催眠貘","引夢貘人","大鉗蟹",
    "巨鉗蟹","霹靂電球","頑皮雷彈","蛋蛋","椰蛋樹","卡拉卡拉","嘎啦嘎啦","飛腿郎","快拳郎","大舌頭",
    "瓦斯彈","雙彈瓦斯","獨角犀牛","鑽角犀獸","吉利蛋","蔓藤怪","袋獸","墨海馬","海刺龍","角金魚",
    "金魚王","海星星","寶石海星","魔牆人偶","飛天螳螂","迷唇姐","電擊獸","鴨嘴火獸","凱羅斯","肯泰羅",
    "鯉魚王","暴鯉龍","拉普拉斯","百變怪","伊布","水伊布","雷伊布","火伊布","多邊獸","菊石獸",
    "多刺菊石獸","化石盔","鐮刀盔","化石翼龍","卡比獸","急凍鳥","閃電鳥","火焰鳥","迷你龍","哈克龍",
    "快龍","超夢","夢幻"
  ];

  const pad3 = n => String(n).padStart(3,"0");
  let RAW = null;

  function median(arr){
    if(!arr.length) return null;
    const a=[...arr].sort((x,y)=>x-y);
    const mid=Math.floor(a.length/2);
    return a.length%2? a[mid] : (a[mid-1]+a[mid])/2;
  }

  function pct(now, prev){
    if(prev==null || prev===0 || now==null) return null;
    return ((now-prev)/prev)*100;
  }

  function fmtJPY(n){
    if(n==null) return "—";
    return "¥" + Math.round(n).toLocaleString("ja-JP");
  }

  function deltaClass(v){
    if(v==null) return "flat";
    if(v>0.0001) return "up";
    if(v<-0.0001) return "down";
    return "flat";
  }

  function buildStats(all){
    const total = all.length;
    const uniq = new Set(all.map(x=>x.no)).size;
    const updated = RAW?.updated_at ? new Date(RAW.updated_at).toLocaleString() : "—";
    const el=document.getElementById("stats");
    el.innerHTML = `
      <span class="chip">資料筆數 <strong>${total}</strong></span>
      <span class="chip">覆蓋編號 <strong>${uniq}/151</strong></span>
      <span class="chip">更新時間 <strong>${updated}</strong></span>
    `;
  }

  function groupByNo(items){
    const m=new Map();
    for(const it of items){
      if(!it.no) continue;
      if(!m.has(it.no)) m.set(it.no, []);
      m.get(it.no).push(it);
    }
    for(const [k,v] of m){
      v.sort((a,b)=>new Date(a.observed_at)-new Date(b.observed_at));
    }
    return m;
  }

  function render(){
    const q=document.getElementById("q").value.trim().toLowerCase();
    const sort=document.getElementById("sort").value;
    const st=document.getElementById("statusFilter").value;

    const all = (RAW?.items||[]);
    buildStats(all);

    const byNoAll = groupByNo(all);

    const rows = [];
    for(let no=1;no<=151;no++){
      const gAll = byNoAll.get(no) || [];
      const gSold = gAll.filter(x=>x.listing_status==="sold_out" && typeof x.price_jpy==="number");
      const gOn   = gAll.filter(x=>x.listing_status==="on_sale" && typeof x.price_jpy==="number");

      const latestSold = gSold.length ? gSold[gSold.length-1].price_jpy : null;
      const prevSold   = gSold.length>=2 ? gSold[gSold.length-2].price_jpy : null;
      const deltaSold  = pct(latestSold, prevSold);

      const latestOn   = gOn.length ? gOn[gOn.length-1].price_jpy : null;

      const name = (gAll[gAll.length-1]?.pokemon_name) || "";
      const zh = ZH[no] || "";

      rows.push({
        no, name, zh,
        gAll, gSold, gOn,
        latestSold, prevSold, deltaSold,
        latestOn,
        count: gAll.length
      });
    }

    let filtered = rows.filter(r=>{
      if(!q) return true;
      return (pad3(r.no)+" "+r.name+" "+r.zh).toLowerCase().includes(q);
    });

    // 狀態過濾（卡片右上角顯示你目前顯示的狀態）
    filtered = filtered.filter(r=>{
      if(st==="all") return true;
      if(st==="sold_out") return r.gSold.length>0;
      if(st==="on_sale") return r.gOn.length>0;
      return true;
    });

    const sorter = {
      delta_sold: (a,b)=>(b.deltaSold??-1e9)-(a.deltaSold??-1e9),
      latest_sold:(a,b)=>(b.latestSold??-1e9)-(a.latestSold??-1e9),
      latest_on:(a,b)=>(b.latestOn??-1e9)-(a.latestOn??-1e9),
      count:(a,b)=>(b.count-a.count),
      id:(a,b)=>(a.no-b.no),
    }[sort] || ((a,b)=>a.no-b.no);

    filtered.sort(sorter);

    const grid=document.getElementById("grid");
    grid.innerHTML="";

    for(const r of filtered){
      const card=document.createElement("div");
      card.className="card";
      const id = pad3(r.no);

      // 你選擇顯示狀態：all 就顯示「混合」，否則顯示對應
      const badgeText = st==="all" ? "混合" : (st==="sold_out" ? "已售出" : "交易中");

      const deltaText = r.deltaSold==null ? "—" : (r.deltaSold>0?`+${r.deltaSold.toFixed(1)}%`:`${r.deltaSold.toFixed(1)}%`);
      const cls = deltaClass(r.deltaSold);

      const lastLink = (st==="on_sale" ? (r.gOn[r.gOn.length-1]?.item_url) : (r.gSold[r.gSold.length-1]?.item_url))
        || (r.gAll[r.gAll.length-1]?.item_url) || "";

      const mercariSearch = `https://jp.mercari.com/search?keyword=${encodeURIComponent("ポケパークカントー ピンバッジ "+(r.name||""))}`;

      card.innerHTML = `
        <div class="badge">${badgeText}</div>
        <div class="row">
          <div>
            <div class="num">#${id}</div>
            <div class="name">${r.name || "（未抓到）"} <span style="color:var(--muted);font-weight:600">／${r.zh}</span></div>
          </div>
          <div class="delta ${cls}">${deltaText}</div>
        </div>

        <div class="k">交易中：目前顯示狀態的最新價格</div>
        <div class="v">${fmtJPY(r.latestOn)}</div>

        <div class="k">已售出：最新成交（前一筆）</div>
        <div class="v">${fmtJPY(r.latestSold)} <span style="color:var(--muted);font-size:12px">（前一筆：${fmtJPY(r.prevSold)}）</span></div>

        <div class="k">資料筆數</div>
        <div class="v">${r.count}</div>

        <div class="chartWrap"><canvas id="c_${id}"></canvas></div>

        <div class="links">
          ${lastLink ? `<a class="pill" href="${lastLink}" target="_blank" rel="noopener">最新一筆頁面</a>` : ``}
          <a class="pill" href="${mercariSearch}" target="_blank" rel="noopener">Mercari 搜尋</a>
        </div>
      `;
      grid.appendChild(card);

      // chart：用 observed_at 畫（同時把 sold_out / on_sale 都畫進去）
      const labels = r.gAll.map(x=>new Date(x.observed_at).toLocaleDateString());
      const data = r.gAll.map(x=>x.price_jpy);

      const ctx = card.querySelector(`#c_${id}`);
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: `#${id}`, data, borderWidth: 2, pointRadius: 2 }] },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{ y:{ ticks:{ callback:(v)=>"¥"+Number(v).toLocaleString("ja-JP") } } },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmtJPY(c.parsed.y) } } }
        }
      });
    }
  }

  async function loadData(){
    const res = await fetch("./data/sold.json?ts="+Date.now());
    if(!res.ok) throw new Error("讀取 data/sold.json 失敗");
    RAW = await res.json();
  }

  document.getElementById("btnReload").addEventListener("click", async ()=>{ await loadData(); render(); });
  document.getElementById("statusFilter").addEventListener("change", render);
  document.getElementById("sort").addEventListener("change", render);
  document.getElementById("q").addEventListener("input", render);

  (async ()=>{ await loadData(); render(); })();
</script>
</body>
</html>
