<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PokéPark KANTO Pins 漲跌幅追蹤（Mercari）</title>
  <style>
    :root{--bg:#0b0d12;--card:#121624;--muted:#8b94aa;--text:#e9ecf5;--line:#232a3d;--chip:#1b2235;--accent:#7aa2ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:linear-gradient(180deg,#0b0d12,#0b0d12 40%,#0e1220);color:var(--text)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    header{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;margin-bottom:14px}
    h1{font-size:18px;margin:0}
    .sub{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.6}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select,button{
      background:var(--card);border:1px solid var(--line);color:var(--text);
      border-radius:12px;padding:10px 12px;font-size:14px;outline:none
    }
    button{cursor:pointer}
    .chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .chip{background:var(--chip);border:1px solid var(--line);color:var(--muted);padding:7px 10px;border-radius:999px;font-size:12px}
    .chip strong{color:var(--text)}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:14px}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media (max-width:760px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media (max-width:520px){.grid{grid-template-columns:repeat(1,minmax(0,1fr))}}
    .card{background:linear-gradient(180deg,#121624,#0f1320);border:1px solid var(--line);border-radius:16px;padding:12px}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:flex-end}
    .num{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}
    .name{font-size:14px;font-weight:750}
    .k{color:var(--muted);font-size:12px;margin-top:10px}
    .v{font-size:14px;margin-top:6px}
    .delta{font-variant-numeric:tabular-nums;font-size:13px}
    .delta.up{color:#7CFFB2}
    .delta.down{color:#FF7C7C}
    .delta.flat{color:#C7D2FE}
    .links{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
    a.pill{display:inline-flex;gap:8px;align-items:center;text-decoration:none;background:#1c2743;border:1px solid #2a3960;color:#cfe0ff;padding:6px 8px;border-radius:999px;font-size:12px}
    .chartWrap{margin-top:10px;background:#0b0d12;border:1px solid var(--line);border-radius:12px;padding:10px}
    canvas{width:100%;height:220px}
    .footer{margin-top:16px;color:var(--muted);font-size:12px;line-height:1.6}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>PokéPark KANTO Pins 漲跌幅追蹤（Mercari Sold）</h1>
        <div class="sub">
          自動抓取 Mercari「已售出」且標題含 <span class="mono">No. ####</span> + 寶可夢名稱 的刊登，彙整成交價（JPY）。<br/>
          你可切換關鍵字：<span class="mono">pokemon park kanto pin</span> / <span class="mono">ポケパークカントー ピンズ ピンバッチ</span>
        </div>
        <div class="chips" id="stats"></div>
      </div>

      <div class="bar">
        <select id="kw">
          <option value="pokemon park kanto pin">pokemon park kanto pin</option>
          <option value="ポケパークカントー ピンズ ピンバッチ">ポケパークカントー ピンズ ピンバッチ</option>
        </select>
        <select id="sort">
          <option value="delta">排序：漲跌幅</option>
          <option value="latest">排序：最新成交</option>
          <option value="median7">排序：7日中位數</option>
          <option value="count7">排序：7日筆數</option>
          <option value="id">排序：編號</option>
        </select>
        <input id="q" placeholder="搜尋：編號/名稱（例 150 或 ミュウツー）" />
        <button id="btnReload">重新載入資料</button>
      </div>
    </header>

    <main class="grid" id="grid"></main>

    <div class="footer">
      資料來源：Mercari 公開頁面（以低頻率擷取）。若遇到平台反爬導致更新失敗，Actions 會顯示錯誤紀錄。<br/>
      提醒：這是「成交價追蹤工具」，不顯示任何你不想看的價格之外資訊也可；如要忽略某些條件可在 scraper 內調整。
    </div>
  </div>

<script>
  const ZH = ["",
    "妙蛙種子","妙蛙草","妙蛙花","小火龍","火恐龍","噴火龍","傑尼龜","卡咪龜","水箭龜",
    "綠毛蟲","鐵甲蛹","巴大蝶","獨角蟲","鐵殼蛹","大針蜂","波波","比比鳥","大比鳥",
    "小拉達","拉達","烈雀","大嘴雀","阿柏蛇","阿柏怪","皮卡丘","雷丘","穿山鼠","穿山王",
    "尼多蘭","尼多娜","尼多后","尼多朗","尼多力諾","尼多王","皮皮","皮可西","六尾","九尾",
    "胖丁","胖可丁","超音蝠","大嘴蝠","走路草","臭臭花","霸王花","派拉斯","派拉斯特","毛球",
    "摩魯蛾","地鼠","三地鼠","喵喵","貓老大","可達鴨","哥達鴨","猴怪","火爆猴","卡蒂狗",
    "風速狗","蚊香蝌蚪","蚊香君","蚊香泳士","凱西","勇基拉","胡地","腕力","豪力","怪力",
    "喇叭芽","口呆花","大食花","瑪瑙水母","毒刺水母","小拳石","隆隆石","隆隆岩","小火馬","烈焰馬",
    "呆呆獸","呆殼獸","小磁怪","三合一磁怪","大蔥鴨","嘟嘟","嘟嘟利","小海獅","白海獅","臭泥",
    "臭臭泥","大舌貝","刺甲貝","鬼斯","鬼斯通","耿鬼","大岩蛇","催眠貘","引夢貘人","大鉗蟹",
    "巨鉗蟹","霹靂電球","頑皮雷彈","蛋蛋","椰蛋樹","卡拉卡拉","嘎啦嘎啦","飛腿郎","快拳郎","大舌頭",
    "瓦斯彈","雙彈瓦斯","獨角犀牛","鑽角犀獸","吉利蛋","蔓藤怪","袋獸","墨海馬","海刺龍","角金魚",
    "金魚王","海星星","寶石海星","魔牆人偶","飛天螳螂","迷唇姐","電擊獸","鴨嘴火獸","凱羅斯","肯泰羅",
    "鯉魚王","暴鯉龍","拉普拉斯","百變怪","伊布","水伊布","雷伊布","火伊布","多邊獸","菊石獸",
    "多刺菊石獸","化石盔","鐮刀盔","化石翼龍","卡比獸","急凍鳥","閃電鳥","火焰鳥","迷你龍","哈克龍",
    "快龍","超夢","夢幻"
  ];
  const pad3 = n => String(n).padStart(3,"0");

  // data/sold.json 由 Actions 產生：{ updated_at, keyword, items:[{id,title,price_jpy,sold_at,item_url,no,pokemon_name}] }
  let RAW = null;
  const charts = new Map();

  function median(arr){
    if(!arr.length) return null;
    const a=[...arr].sort((x,y)=>x-y);
    const mid=Math.floor(a.length/2);
    return a.length%2? a[mid] : (a[mid-1]+a[mid])/2;
  }

  function pct(now, prev){
    if(prev==null || prev===0 || now==null) return null;
    return ((now-prev)/prev)*100;
  }

  function fmtJPY(n){
    if(n==null) return "—";
    return "¥" + Math.round(n).toLocaleString("ja-JP");
  }

  function deltaClass(v){
    if(v==null) return "flat";
    if(v>0.0001) return "up";
    if(v<-0.0001) return "down";
    return "flat";
  }

  function buildStats(all){
    const total = all.length;
    const uniq = new Set(all.map(x=>x.no)).size;
    const updated = RAW?.updated_at ? new Date(RAW.updated_at).toLocaleString() : "—";
    const el=document.getElementById("stats");
    el.innerHTML = `
      <span class="chip">資料筆數 <strong>${total}</strong></span>
      <span class="chip">覆蓋編號 <strong>${uniq}/151</strong></span>
      <span class="chip">更新時間 <strong>${updated}</strong></span>
    `;
  }

  function groupByNo(items){
    const m=new Map();
    for(const it of items){
      if(!it.no) continue;
      if(!m.has(it.no)) m.set(it.no, []);
      m.get(it.no).push(it);
    }
    // sort each group by sold_at asc
    for(const [k,v] of m){
      v.sort((a,b)=>new Date(a.sold_at)-new Date(b.sold_at));
    }
    return m;
  }

  function render(){
    const kw=document.getElementById("kw").value;
    const q=document.getElementById("q").value.trim().toLowerCase();
    const sort=document.getElementById("sort").value;

    const items = (RAW?.items||[]).filter(x=>x.keyword===kw);
    buildStats(items);

    const byNo = groupByNo(items);
    const rows = [];
    for(let no=1;no<=151;no++){
      const g = byNo.get(no) || [];
      const name = g[g.length-1]?.pokemon_name || "";
      const zh = ZH[no] || "";
      const latest = g.length ? g[g.length-1].price_jpy : null;

      const now = new Date();
      const cutoff7 = new Date(now.getTime()-7*24*3600*1000);
      const g7 = g.filter(x=>new Date(x.sold_at) >= cutoff7);
      const prices7 = g7.map(x=>x.price_jpy).filter(x=>typeof x==="number");
      const med7 = prices7.length ? median(prices7) : null;

      const prev = g.length>=2 ? g[g.length-2].price_jpy : null;
      const d = pct(latest, prev);

      rows.push({no, name, zh, latest, prev, delta:d, med7, count7:prices7.length, g});
    }

    let filtered = rows.filter(r=>{
      if(!q) return true;
      return (pad3(r.no)+" "+r.name+" "+r.zh).toLowerCase().includes(q);
    });

    const sorter = {
      delta: (a,b)=>(b.delta??-1e9)-(a.delta??-1e9),
      latest:(a,b)=>(b.latest??-1e9)-(a.latest??-1e9),
      median7:(a,b)=>(b.med7??-1e9)-(a.med7??-1e9),
      count7:(a,b)=>(b.count7)-(a.count7),
      id:(a,b)=>(a.no-b.no),
    }[sort] || ((a,b)=>a.no-b.no);

    filtered.sort(sorter);

    const grid=document.getElementById("grid");
    grid.innerHTML="";
    charts.clear();

    for(const r of filtered){
      const card=document.createElement("div");
      card.className="card";
      const id = pad3(r.no);
      const deltaText = r.delta==null ? "—" : (r.delta>0?`+${r.delta.toFixed(1)}%`:`${r.delta.toFixed(1)}%`);
      const cls = deltaClass(r.delta);

      const lastLink = r.g.length ? r.g[r.g.length-1].item_url : "";
      const mercariSearch = `https://jp.mercari.com/search?keyword=${encodeURIComponent("ポケパークカントー ピンバッジ No. "+id+" "+(r.name||""))}`;

      card.innerHTML = `
        <div class="row">
          <div>
            <div class="num">#${id}</div>
            <div class="name">${r.name || "（未抓到）"} <span style="color:var(--muted);font-weight:600">／${r.zh}</span></div>
          </div>
          <div class="delta ${cls}">${deltaText}</div>
        </div>

        <div class="k">最新成交</div>
        <div class="v">${fmtJPY(r.latest)} <span style="color:var(--muted);font-size:12px">（前一筆：${fmtJPY(r.prev)}）</span></div>

        <div class="k">7 日中位數 / 7 日筆數</div>
        <div class="v">${fmtJPY(r.med7)} <span style="color:var(--muted);font-size:12px">／${r.count7}</span></div>

        <div class="chartWrap"><canvas id="c_${id}"></canvas></div>

        <div class="links">
          ${lastLink ? `<a class="pill" href="${lastLink}" target="_blank" rel="noopener">最新成交頁</a>` : ``}
          <a class="pill" href="${mercariSearch}" target="_blank" rel="noopener">Mercari 搜尋（No.${id}）</a>
        </div>
      `;
      grid.appendChild(card);

      // chart
      const labels = r.g.map(x=>new Date(x.sold_at).toLocaleDateString());
      const data = r.g.map(x=>x.price_jpy);
      const ctx = card.querySelector(`#c_${id}`);
      new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label: `#${id}`, data, borderWidth: 2, pointRadius: 2 }] },
        options: {
          responsive:true,
          maintainAspectRatio:false,
          scales:{ y:{ ticks:{ callback:(v)=>"¥"+Number(v).toLocaleString("ja-JP") } } },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:(c)=>fmtJPY(c.parsed.y) } } }
        }
      });
    }
  }

  async function loadData(){
    const res = await fetch("./data/sold.json?ts="+Date.now());
    if(!res.ok) throw new Error("讀取 data/sold.json 失敗");
    RAW = await res.json();
  }

  document.getElementById("btnReload").addEventListener("click", async ()=>{
    await loadData(); render();
  });
  document.getElementById("kw").addEventListener("change", render);
  document.getElementById("sort").addEventListener("change", render);
  document.getElementById("q").addEventListener("input", render);

  (async ()=>{ await loadData(); render(); })();
</script>
</body>
</html>
